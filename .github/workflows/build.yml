name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Deploy Qt dependencies
        shell: pwsh
        run: |
          $env:PATH = "$env:Qt6_DIR\bin;$env:PATH"
          windeployqt --release build\Release\ApkStudio.exe

      - name: Create archive
        shell: pwsh
        run: |
          Compress-Archive -Path build\Release\* -DestinationPath ApkStudio-Windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ApkStudio-Windows-x64
          path: ApkStudio-Windows-x64.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release -j$(nproc)

      - name: Install
        run: |
          cmake --install build --prefix install

      - name: Download linuxdeploy and plugins
        run: |
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage"
          chmod +x linuxdeploy*.AppImage

      - name: Find executable
        run: |
          echo "Searching for executable..."
          find . -type f -executable \( -name "ApkStudio" -o -name "apkstudio" \) 2>/dev/null | head -5
          ls -la install/bin/ 2>/dev/null || echo "install/bin/ does not exist"
          ls -la build/ 2>/dev/null | head -10 || echo "build/ does not exist"

      - name: Prepare AppDir for AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          # Find the executable (could be ApkStudio or apkstudio, in build or install)
          EXECUTABLE=""
          if [ -f install/bin/ApkStudio ]; then
            EXECUTABLE="install/bin/ApkStudio"
          elif [ -f install/bin/apkstudio ]; then
            EXECUTABLE="install/bin/apkstudio"
          elif [ -f build/ApkStudio ]; then
            EXECUTABLE="build/ApkStudio"
          elif [ -f build/apkstudio ]; then
            EXECUTABLE="build/apkstudio"
          else
            echo "Error: Executable not found. Listing directories..."
            find . -type f -executable -name "*pk*" 2>/dev/null || true
            exit 1
          fi
          echo "Found executable at: $EXECUTABLE"
          cp "$EXECUTABLE" AppDir/usr/bin/apkstudio
          mkdir -p AppDir/usr/share/applications
          cp ${{ github.workspace }}/resources/apkstudio.desktop AppDir/usr/share/applications/
          cp ${{ github.workspace }}/resources/icon.png AppDir/apkstudio.png
          chmod +x AppDir/usr/bin/apkstudio

      - name: Create AppImage with linuxdeploy
        run: |
          export QTDIR=${{ env.QT_ROOT_DIR }}
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --executable AppDir/usr/bin/apkstudio --desktop-file AppDir/usr/share/applications/apkstudio.desktop --icon-file AppDir/apkstudio.png --plugin qt --output appimage

      - name: Rename AppImage if tagged
        run: |
          if [ ! -z "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            if [ -f ApkStudio-x86_64.AppImage ]; then
              mv ApkStudio-x86_64.AppImage ApkStudio-${TAG_NAME}-x86_64.AppImage
            fi
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ApkStudio-Linux-x64
          path: ApkStudio*.AppImage
          if-no-files-found: error
          retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Install
        run: |
          cmake --install build --prefix install

      - name: Deploy Qt dependencies with macdeployqt
        run: |
          export PATH="$Qt6_DIR/bin:$PATH"
          APP_BUNDLE=""
          # Find the app bundle
          if [ -d install/bin/ApkStudio.app ]; then
            APP_BUNDLE="install/bin/ApkStudio.app"
          elif [ -d build/Release/ApkStudio.app ]; then
            APP_BUNDLE="build/Release/ApkStudio.app"
          elif [ -d build/Debug/ApkStudio.app ]; then
            APP_BUNDLE="build/Debug/ApkStudio.app"
          elif [ -d build/ApkStudio.app ]; then
            APP_BUNDLE="build/ApkStudio.app"
          else
            FOUND_APP=$(find . -type d -name "ApkStudio.app" 2>/dev/null | head -1)
            if [ -n "$FOUND_APP" ]; then
              APP_BUNDLE="$FOUND_APP"
            fi
          fi
          if [ -n "$APP_BUNDLE" ] && [ -d "$APP_BUNDLE" ]; then
            echo "Deploying Qt dependencies to: $APP_BUNDLE"
            macdeployqt "$APP_BUNDLE" -always-overwrite
          else
            echo "Warning: ApkStudio.app not found for macdeployqt"
            find . -type d -name "*.app" 2>/dev/null || true
          fi

      - name: Find app bundle
        run: |
          echo "Searching for ApkStudio.app..."
          find . -type d -name "*.app" 2>/dev/null | head -10
          ls -la install/bin/ 2>/dev/null || echo "install/bin/ does not exist"
          ls -la build/ 2>/dev/null | head -10 || echo "build/ does not exist"

      - name: Create DMG
        run: |
          APP_PATH=""
          # Check various possible locations
          if [ -d install/bin/ApkStudio.app ]; then
            APP_PATH="install/bin/ApkStudio.app"
          elif [ -d build/Release/ApkStudio.app ]; then
            APP_PATH="build/Release/ApkStudio.app"
          elif [ -d build/Debug/ApkStudio.app ]; then
            APP_PATH="build/Debug/ApkStudio.app"
          elif [ -d build/ApkStudio.app ]; then
            APP_PATH="build/ApkStudio.app"
          else
            # Try to find it
            FOUND_APP=$(find . -type d -name "ApkStudio.app" 2>/dev/null | head -1)
            if [ -n "$FOUND_APP" ]; then
              APP_PATH="$FOUND_APP"
            fi
          fi
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "Found app bundle at: $APP_PATH"
            DMG_DIR_NAME=ApkStudio
            if [ -d $DMG_DIR_NAME ]; then
              rm -rf $DMG_DIR_NAME
            fi
            mkdir -p $DMG_DIR_NAME
            cp -R "$APP_PATH" $DMG_DIR_NAME/
            ln -s /Applications $DMG_DIR_NAME/Applications
            hdiutil create -volname "ApkStudio" -srcfolder $DMG_DIR_NAME -ov -format UDZO ApkStudio-macOS-x64.dmg
          else
            echo "Error: ApkStudio.app not found"
            echo "Searched in: install/bin/, build/Release/, build/Debug/, build/"
            find . -type d -name "*.app" 2>/dev/null || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ApkStudio-macOS-x64
          path: ApkStudio-macOS-x64.dmg
          if-no-files-found: error
          retention-days: 30
